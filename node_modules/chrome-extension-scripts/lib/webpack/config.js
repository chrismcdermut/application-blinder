'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _webpackCombineLoaders = require('webpack-combine-loaders');

var _webpackCombineLoaders2 = _interopRequireDefault(_webpackCombineLoaders);

var _precss = require('precss');

var _precss2 = _interopRequireDefault(_precss);

var _autoprefixer = require('autoprefixer');

var _autoprefixer2 = _interopRequireDefault(_autoprefixer);

var _remove = require('../utils/remove');

var Remove = _interopRequireWildcard(_remove);

var _plugin = require('../manifest/plugin');

var _plugin2 = _interopRequireDefault(_plugin);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

// NOTE: Style preprocessors
// If you want to use any of style preprocessor, add related npm package + loader and uncomment following line
var styleLoaders = {
  'css': 'postcss-loader',
  'less': 'less-loader',
  'scss|sass': 'sass-loader'
};

function makeStyleLoaders() {
  return Object.keys(styleLoaders).map(function (ext) {
    // TODO: Autoprefixer just for webkit. You can guess why :D
    var prefix = 'css-loader?sourceMap&root=../assets';
    var loader = 'style-loader!' + prefix + '!' + styleLoaders[ext];;

    return {
      test: new RegExp('\\.(' + ext + ')$'),
      loader: loader
    };
  });
}

function config(Manifest) {
  var isDevelopment = process.env.NODE_ENV == "development" || true;

  return {
    ///// Lowlevel config
    cache: isDevelopment,
    debug: isDevelopment,
    devtool: isDevelopment ? 'cheap-module-eval-source-map' : '',
    node: { __dirname: true },

    ///// App config

    // Entry points in your app
    // There we use scripts from your manifest.json
    entry: {},

    // Output
    output: function () {
      var output = {
        path: Manifest.buildPath,
        filename: '[name].js'
      };

      if (isDevelopment) {
        output = _extends({}, output, {
          chunkFilename: '[name]-[chunkhash].js',
          publicPath: 'https://localhost:3001/'
        });
      }

      return output;
    }(),

    // Plugins
    plugins: function () {
      var plugins = [new _plugin2.default(Manifest, isDevelopment), new _webpack2.default.DefinePlugin({
        "global.GENTLY": false,
        "process.env": {
          APP_ENV: JSON.stringify(process.env.APP_ENV),
          NODE_ENV: JSON.stringify(process.env.NODE_ENV),
          IS_BROWSER: true
        }
      })];

      if (isDevelopment) {
        // Development plugins for hot reload
        plugins = [].concat(_toConsumableArray(plugins), [
        // NotifyPlugin,
        new _webpack2.default.HotModuleReplacementPlugin(),
        // Tell reloader to not reload if there is an error.
        new _webpack2.default.NoErrorsPlugin()]);
      } else {
        // Production plugins for optimizing code
        plugins = [].concat(_toConsumableArray(plugins), [new _webpack2.default.optimize.OccurrenceOrderPlugin(), new _webpack2.default.optimize.DedupePlugin(), new _webpack2.default.optimize.UglifyJsPlugin({
          compress: {
            screw_ie8: true, // React doesn't support IE8
            warnings: false
          },
          mangle: {
            screw_ie8: true
          },
          output: {
            comments: false,
            screw_ie8: true
          }
        }), function () {
          this.plugin("done", function (stats) {
            if (stats.compilation.errors && stats.compilation.errors.length) {
              console.log(stats.compilation.errors);
              process.exit(1);
            }
          });
        }]);
      }

      // NOTE: Custom plugins
      // if you need to exclude anything pro loading
      // plugins.push(new webpack.IgnorePlugin(/^(vertx|somethingelse)$/))

      return plugins;
    }(),

    // NOTE: Override external requires
    // If you need to change value of required (imported) module
    // for example if you dont want any module import 'net' for various reason like code only for non browser envirinment
    externals: {
      // net: function() {}
    },

    resolve: {
      extensions: ['', '.js', '.jsx', '.json'],
      modulesDirectories: ['src', 'node_modules'],
      root: [Manifest.src],
      alias: function () {
        // NOTE: Aliasing
        // If you want to override some path with another. Good for importing same version of React across different libraries
        var alias = {
          // "react-fa-icon": require.resolve(path.resolve(Manifest.src, 'lib/react-fa-icon'))
          // "lodash$": require.resolve(path.join(__dirname, '../node_modules/lodash')),
          // "promise$": require.resolve(path.join(__dirname, '../node_modules/bluebird')),
          // "bluebird$": require.resolve(path.join(__dirname, '../node_modules/bluebird')),
          // "immutable$": require.resolve(path.join(__dirname, '../node_modules/immutable')),
          // "react$": require.resolve(path.join(__dirname, '../node_modules/react'))
          // "react-dom$": require.resolve(path.join(__dirname, '../node_modules/react-dom'))
        };

        return alias;
      }()
    },

    // Loaders
    module: {
      loaders: function () {
        var loaders = [
        // Assets

        // TODO: just some assets I use often. Need to be more dynamic
        {
          test: /\.(png|jpg|jpeg|gif|svg|wav|woff|woff2|ttf|eot)/,
          exclude: exclude,
          loader: "url-loader?limit=1000000&name=[name]-[hash].[ext]"
        }].concat(_toConsumableArray(makeStyleLoaders()), [

        // Scripts
        function () {
          var base = {
            test: /\.jsx?$/,
            exclude: exclude
          };

          var babelQuery = {
            cacheDirectory: true,
            plugins: ["transform-decorators-legacy"],
            presets: ["react", "es2015", "es2016", "es2017", "stage-0"]
            // [
            //   [
            //     "target", {
            //       plugins: [ "transform-decorators-legacy" ],
            //       presets: [ "es2015", "es2016", "es2017", "stage-0" ],
            //       targets: [
            //         { name: "chrome", version: 52 }
            //       ]
            //     }
            //   ]
            // ]
          };

          if (isDevelopment) {
            babelQuery.presets = ["react-hmre"].concat(_toConsumableArray(babelQuery.presets));

            return _extends({}, base, {
              loader: 'babel-loader',
              query: babelQuery
              // loader: combineLoaders([
              //   {
              //     loader: 'react-hot-loader'
              //   },
              //   {
              //     loader: 'babel-loader',
              //     query: babelQuery
              //   }
              // ])
            });
          } else {
            return _extends({}, base, {
              loader: 'babel-loader',
              query: babelQuery
            });
          }
        }(),

        // Json
        {
          test: /\.json/,
          exclude: exclude,
          loader: "json-loader"
        }
        // NOTE: Add more loaders here
        ]);

        return loaders;
      }()
    },
    postcss: function postcss() {
      return [_precss2.default, _autoprefixer2.default];
    }
  };
}

exports.default = config;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93ZWJwYWNrL2NvbmZpZy5qcyJdLCJuYW1lcyI6WyJSZW1vdmUiLCJzdHlsZUxvYWRlcnMiLCJtYWtlU3R5bGVMb2FkZXJzIiwiT2JqZWN0Iiwia2V5cyIsIm1hcCIsImV4dCIsInByZWZpeCIsImxvYWRlciIsInRlc3QiLCJSZWdFeHAiLCJjb25maWciLCJNYW5pZmVzdCIsImlzRGV2ZWxvcG1lbnQiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJjYWNoZSIsImRlYnVnIiwiZGV2dG9vbCIsIm5vZGUiLCJfX2Rpcm5hbWUiLCJlbnRyeSIsIm91dHB1dCIsInBhdGgiLCJidWlsZFBhdGgiLCJmaWxlbmFtZSIsImNodW5rRmlsZW5hbWUiLCJwdWJsaWNQYXRoIiwicGx1Z2lucyIsIkRlZmluZVBsdWdpbiIsIkFQUF9FTlYiLCJKU09OIiwic3RyaW5naWZ5IiwiSVNfQlJPV1NFUiIsIkhvdE1vZHVsZVJlcGxhY2VtZW50UGx1Z2luIiwiTm9FcnJvcnNQbHVnaW4iLCJvcHRpbWl6ZSIsIk9jY3VycmVuY2VPcmRlclBsdWdpbiIsIkRlZHVwZVBsdWdpbiIsIlVnbGlmeUpzUGx1Z2luIiwiY29tcHJlc3MiLCJzY3Jld19pZTgiLCJ3YXJuaW5ncyIsIm1hbmdsZSIsImNvbW1lbnRzIiwicGx1Z2luIiwic3RhdHMiLCJjb21waWxhdGlvbiIsImVycm9ycyIsImxlbmd0aCIsImNvbnNvbGUiLCJsb2ciLCJleGl0IiwiZXh0ZXJuYWxzIiwicmVzb2x2ZSIsImV4dGVuc2lvbnMiLCJtb2R1bGVzRGlyZWN0b3JpZXMiLCJyb290Iiwic3JjIiwiYWxpYXMiLCJtb2R1bGUiLCJsb2FkZXJzIiwiZXhjbHVkZSIsImJhc2UiLCJiYWJlbFF1ZXJ5IiwiY2FjaGVEaXJlY3RvcnkiLCJwcmVzZXRzIiwicXVlcnkiLCJwb3N0Y3NzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7O0lBQVlBLE07O0FB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LGdDQUNLSCxJQURMO0FBRUV4RCxzQkFBUSxjQUZWO0FBR0U0RCxxQkFBT0g7QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFaRjtBQWNELFdBcEJELE1Bb0JPO0FBQ0wsZ0NBQ0tELElBREw7QUFFRXhELHNCQUFRLGNBRlY7QUFHRTRELHFCQUFPSDtBQUhUO0FBS0Q7QUFDRixTQWxERCxFQWJFOztBQWlFRjtBQUNBO0FBQ0V4RCxnQkFBTSxRQURSO0FBRUVzRCxtQkFBU0EsT0FGWDtBQUdFdkQsa0JBQVE7QUFIVjtBQUtBO0FBdkVFLFVBQUo7O0FBMEVBLGVBQU9zRCxPQUFQO0FBQ0QsT0E1RVE7QUFESCxLQW5JSDtBQWtOTE8sYUFBUyxtQkFBWTtBQUNuQixhQUFPLDBDQUFQO0FBQ0Q7QUFwTkksR0FBUDtBQXNORDs7a0JBRWMxRCxNIiwiZmlsZSI6ImNvbmZpZy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snO1xuaW1wb3J0IGNvbWJpbmVMb2FkZXJzIGZyb20gJ3dlYnBhY2stY29tYmluZS1sb2FkZXJzJ1xuaW1wb3J0IHByZWNzcyBmcm9tICdwcmVjc3MnXG5pbXBvcnQgYXV0b3ByZWZpeGVyIGZyb20gJ2F1dG9wcmVmaXhlcidcblxuaW1wb3J0ICogYXMgUmVtb3ZlIGZyb20gJy4uL3V0aWxzL3JlbW92ZSdcbmltcG9ydCBNYW5pZmVzdFBsdWdpbiBmcm9tICcuLi9tYW5pZmVzdC9wbHVnaW4nXG5cbi8vIE5PVEU6IFN0eWxlIHByZXByb2Nlc3NvcnNcbi8vIElmIHlvdSB3YW50IHRvIHVzZSBhbnkgb2Ygc3R5bGUgcHJlcHJvY2Vzc29yLCBhZGQgcmVsYXRlZCBucG0gcGFja2FnZSArIGxvYWRlciBhbmQgdW5jb21tZW50IGZvbGxvd2luZyBsaW5lXG5jb25zdCBzdHlsZUxvYWRlcnMgPSB7XG4gICdjc3MnOiAncG9zdGNzcy1sb2FkZXInLFxuICAnbGVzcyc6ICdsZXNzLWxvYWRlcicsXG4gICdzY3NzfHNhc3MnOiAnc2Fzcy1sb2FkZXInXG59O1xuXG5mdW5jdGlvbiBtYWtlU3R5bGVMb2FkZXJzKCkge1xuICByZXR1cm4gT2JqZWN0LmtleXMoc3R5bGVMb2FkZXJzKS5tYXAoZnVuY3Rpb24oZXh0KSB7XG4gICAgLy8gVE9ETzogQXV0b3ByZWZpeGVyIGp1c3QgZm9yIHdlYmtpdC4gWW91IGNhbiBndWVzcyB3aHkgOkRcbiAgICB2YXIgcHJlZml4ID0gJ2Nzcy1sb2FkZXI/c291cmNlTWFwJnJvb3Q9Li4vYXNzZXRzJ1xuICAgIHZhciBsb2FkZXIgPSAnc3R5bGUtbG9hZGVyIScgKyBwcmVmaXggKyAnIScgKyBzdHlsZUxvYWRlcnNbZXh0XTs7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdGVzdDogbmV3IFJlZ0V4cCgnXFxcXC4oJyArIGV4dCArICcpJCcpLFxuICAgICAgbG9hZGVyOiBsb2FkZXJcbiAgICB9O1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY29uZmlnKE1hbmlmZXN0KSB7XG4gIGNvbnN0IGlzRGV2ZWxvcG1lbnQgPSBwcm9jZXNzLmVudi5OT0RFX0VOViA9PSBcImRldmVsb3BtZW50XCIgfHwgdHJ1ZVxuXG4gIHJldHVybiB7XG4gICAgLy8vLy8gTG93bGV2ZWwgY29uZmlnXG4gICAgY2FjaGU6IGlzRGV2ZWxvcG1lbnQsXG4gICAgZGVidWc6IGlzRGV2ZWxvcG1lbnQsXG4gICAgZGV2dG9vbDogaXNEZXZlbG9wbWVudCA/ICdjaGVhcC1tb2R1bGUtZXZhbC1zb3VyY2UtbWFwJyA6ICcnLFxuICAgIG5vZGU6IHsgX19kaXJuYW1lOiB0cnVlIH0sXG5cbiAgICAvLy8vLyBBcHAgY29uZmlnXG5cbiAgICAvLyBFbnRyeSBwb2ludHMgaW4geW91ciBhcHBcbiAgICAvLyBUaGVyZSB3ZSB1c2Ugc2NyaXB0cyBmcm9tIHlvdXIgbWFuaWZlc3QuanNvblxuICAgIGVudHJ5OiB7fSxcblxuICAgIC8vIE91dHB1dFxuICAgIG91dHB1dDogKGZ1bmN0aW9uKCkge1xuICAgICAgbGV0IG91dHB1dCA9IHtcbiAgICAgICAgcGF0aDogTWFuaWZlc3QuYnVpbGRQYXRoLFxuICAgICAgICBmaWxlbmFtZTogJ1tuYW1lXS5qcydcbiAgICAgIH1cblxuICAgICAgaWYoaXNEZXZlbG9wbWVudCkge1xuICAgICAgICBvdXRwdXQgPSB7XG4gICAgICAgICAgLi4ub3V0cHV0LFxuICAgICAgICAgIGNodW5rRmlsZW5hbWU6ICdbbmFtZV0tW2NodW5raGFzaF0uanMnLFxuICAgICAgICAgIHB1YmxpY1BhdGg6ICdodHRwczovL2xvY2FsaG9zdDozMDAxLydcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gb3V0cHV0XG4gICAgfSkoKSxcblxuICAgIC8vIFBsdWdpbnNcbiAgICBwbHVnaW5zOiAoZnVuY3Rpb24oKSB7XG4gICAgICBsZXQgcGx1Z2lucyA9IFtcbiAgICAgICAgbmV3IE1hbmlmZXN0UGx1Z2luKE1hbmlmZXN0LCBpc0RldmVsb3BtZW50KSxcbiAgICAgICAgbmV3IHdlYnBhY2suRGVmaW5lUGx1Z2luKHtcbiAgICAgICAgICBcImdsb2JhbC5HRU5UTFlcIjogZmFsc2UsXG4gICAgICAgICAgXCJwcm9jZXNzLmVudlwiOiB7XG4gICAgICAgICAgICBBUFBfRU5WOiAgSlNPTi5zdHJpbmdpZnkocHJvY2Vzcy5lbnYuQVBQX0VOViksXG4gICAgICAgICAgICBOT0RFX0VOVjogSlNPTi5zdHJpbmdpZnkocHJvY2Vzcy5lbnYuTk9ERV9FTlYpLFxuICAgICAgICAgICAgSVNfQlJPV1NFUjogdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIF07XG5cbiAgICAgIGlmKGlzRGV2ZWxvcG1lbnQpIHtcbiAgICAgICAgLy8gRGV2ZWxvcG1lbnQgcGx1Z2lucyBmb3IgaG90IHJlbG9hZFxuICAgICAgICBwbHVnaW5zID0gW1xuICAgICAgICAgIC4uLnBsdWdpbnMsXG4gICAgICAgICAgLy8gTm90aWZ5UGx1Z2luLFxuICAgICAgICAgIG5ldyB3ZWJwYWNrLkhvdE1vZHVsZVJlcGxhY2VtZW50UGx1Z2luKCksXG4gICAgICAgICAgLy8gVGVsbCByZWxvYWRlciB0byBub3QgcmVsb2FkIGlmIHRoZXJlIGlzIGFuIGVycm9yLlxuICAgICAgICAgIG5ldyB3ZWJwYWNrLk5vRXJyb3JzUGx1Z2luKClcbiAgICAgICAgXVxuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBQcm9kdWN0aW9uIHBsdWdpbnMgZm9yIG9wdGltaXppbmcgY29kZVxuICAgICAgICBwbHVnaW5zID0gW1xuICAgICAgICAgIC4uLnBsdWdpbnMsXG4gICAgICAgICAgbmV3IHdlYnBhY2sub3B0aW1pemUuT2NjdXJyZW5jZU9yZGVyUGx1Z2luKCksXG4gICAgICAgICAgbmV3IHdlYnBhY2sub3B0aW1pemUuRGVkdXBlUGx1Z2luKCksXG4gICAgICAgICAgbmV3IHdlYnBhY2sub3B0aW1pemUuVWdsaWZ5SnNQbHVnaW4oe1xuICAgICAgICAgICAgY29tcHJlc3M6IHtcbiAgICAgICAgICAgICAgc2NyZXdfaWU4OiB0cnVlLCAvLyBSZWFjdCBkb2Vzbid0IHN1cHBvcnQgSUU4XG4gICAgICAgICAgICAgIHdhcm5pbmdzOiBmYWxzZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1hbmdsZToge1xuICAgICAgICAgICAgICBzY3Jld19pZTg6IHRydWVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvdXRwdXQ6IHtcbiAgICAgICAgICAgICAgY29tbWVudHM6IGZhbHNlLFxuICAgICAgICAgICAgICBzY3Jld19pZTg6IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSxcbiAgICAgICAgICBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHRoaXMucGx1Z2luKFwiZG9uZVwiLCBmdW5jdGlvbihzdGF0cykge1xuICAgICAgICAgICAgICBpZiAoc3RhdHMuY29tcGlsYXRpb24uZXJyb3JzICYmIHN0YXRzLmNvbXBpbGF0aW9uLmVycm9ycy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhzdGF0cy5jb21waWxhdGlvbi5lcnJvcnMpXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9XG5cbiAgICAgIC8vIE5PVEU6IEN1c3RvbSBwbHVnaW5zXG4gICAgICAvLyBpZiB5b3UgbmVlZCB0byBleGNsdWRlIGFueXRoaW5nIHBybyBsb2FkaW5nXG4gICAgICAvLyBwbHVnaW5zLnB1c2gobmV3IHdlYnBhY2suSWdub3JlUGx1Z2luKC9eKHZlcnR4fHNvbWV0aGluZ2Vsc2UpJC8pKVxuXG4gICAgICByZXR1cm4gcGx1Z2lucztcbiAgICB9KSgpLFxuXG4gICAgLy8gTk9URTogT3ZlcnJpZGUgZXh0ZXJuYWwgcmVxdWlyZXNcbiAgICAvLyBJZiB5b3UgbmVlZCB0byBjaGFuZ2UgdmFsdWUgb2YgcmVxdWlyZWQgKGltcG9ydGVkKSBtb2R1bGVcbiAgICAvLyBmb3IgZXhhbXBsZSBpZiB5b3UgZG9udCB3YW50IGFueSBtb2R1bGUgaW1wb3J0ICduZXQnIGZvciB2YXJpb3VzIHJlYXNvbiBsaWtlIGNvZGUgb25seSBmb3Igbm9uIGJyb3dzZXIgZW52aXJpbm1lbnRcbiAgICBleHRlcm5hbHM6IHtcbiAgICAgIC8vIG5ldDogZnVuY3Rpb24oKSB7fVxuICAgIH0sXG5cbiAgICByZXNvbHZlOiB7XG4gICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICcnLFxuICAgICAgICAnLmpzJyxcbiAgICAgICAgJy5qc3gnLFxuICAgICAgICAnLmpzb24nXG4gICAgICBdLFxuICAgICAgbW9kdWxlc0RpcmVjdG9yaWVzOiBbXG4gICAgICAgICdzcmMnLFxuICAgICAgICAnbm9kZV9tb2R1bGVzJ1xuICAgICAgXSxcbiAgICAgIHJvb3Q6IFtcbiAgICAgICAgTWFuaWZlc3Quc3JjXG4gICAgICBdLFxuICAgICAgYWxpYXM6IChmdW5jdGlvbigpIHtcbiAgICAgICAgLy8gTk9URTogQWxpYXNpbmdcbiAgICAgICAgLy8gSWYgeW91IHdhbnQgdG8gb3ZlcnJpZGUgc29tZSBwYXRoIHdpdGggYW5vdGhlci4gR29vZCBmb3IgaW1wb3J0aW5nIHNhbWUgdmVyc2lvbiBvZiBSZWFjdCBhY3Jvc3MgZGlmZmVyZW50IGxpYnJhcmllc1xuICAgICAgICB2YXIgYWxpYXMgPSB7XG4gICAgICAgICAgLy8gXCJyZWFjdC1mYS1pY29uXCI6IHJlcXVpcmUucmVzb2x2ZShwYXRoLnJlc29sdmUoTWFuaWZlc3Quc3JjLCAnbGliL3JlYWN0LWZhLWljb24nKSlcbiAgICAgICAgICAvLyBcImxvZGFzaCRcIjogcmVxdWlyZS5yZXNvbHZlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9ub2RlX21vZHVsZXMvbG9kYXNoJykpLFxuICAgICAgICAgIC8vIFwicHJvbWlzZSRcIjogcmVxdWlyZS5yZXNvbHZlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9ub2RlX21vZHVsZXMvYmx1ZWJpcmQnKSksXG4gICAgICAgICAgLy8gXCJibHVlYmlyZCRcIjogcmVxdWlyZS5yZXNvbHZlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9ub2RlX21vZHVsZXMvYmx1ZWJpcmQnKSksXG4gICAgICAgICAgLy8gXCJpbW11dGFibGUkXCI6IHJlcXVpcmUucmVzb2x2ZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbm9kZV9tb2R1bGVzL2ltbXV0YWJsZScpKSxcbiAgICAgICAgICAvLyBcInJlYWN0JFwiOiByZXF1aXJlLnJlc29sdmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL25vZGVfbW9kdWxlcy9yZWFjdCcpKVxuICAgICAgICAgIC8vIFwicmVhY3QtZG9tJFwiOiByZXF1aXJlLnJlc29sdmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL25vZGVfbW9kdWxlcy9yZWFjdC1kb20nKSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhbGlhcztcbiAgICAgIH0pKClcbiAgICB9LFxuXG4gICAgLy8gTG9hZGVyc1xuICAgIG1vZHVsZToge1xuICAgICAgbG9hZGVyczogKGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbG9hZGVycyA9IFtcbiAgICAgICAgICAvLyBBc3NldHNcblxuICAgICAgICAgIC8vIFRPRE86IGp1c3Qgc29tZSBhc3NldHMgSSB1c2Ugb2Z0ZW4uIE5lZWQgdG8gYmUgbW9yZSBkeW5hbWljXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGVzdDogL1xcLihwbmd8anBnfGpwZWd8Z2lmfHN2Z3x3YXZ8d29mZnx3b2ZmMnx0dGZ8ZW90KS8sXG4gICAgICAgICAgICBleGNsdWRlOiBleGNsdWRlLFxuICAgICAgICAgICAgbG9hZGVyOiBcInVybC1sb2FkZXI/bGltaXQ9MTAwMDAwMCZuYW1lPVtuYW1lXS1baGFzaF0uW2V4dF1cIlxuICAgICAgICAgIH0sXG4gICAgICAgICAgLy8gU3R5bGVzXG4gICAgICAgICAgLi4ubWFrZVN0eWxlTG9hZGVycygpLFxuXG4gICAgICAgICAgLy8gU2NyaXB0c1xuICAgICAgICAgIChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGNvbnN0IGJhc2UgPSB7XG4gICAgICAgICAgICAgIHRlc3Q6IC9cXC5qc3g/JC8sXG4gICAgICAgICAgICAgIGV4Y2x1ZGU6IGV4Y2x1ZGVcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYmFiZWxRdWVyeSA9IHtcbiAgICAgICAgICAgICAgY2FjaGVEaXJlY3Rvcnk6IHRydWUsXG4gICAgICAgICAgICAgIHBsdWdpbnM6IFsgXCJ0cmFuc2Zvcm0tZGVjb3JhdG9ycy1sZWdhY3lcIiBdLFxuICAgICAgICAgICAgICBwcmVzZXRzOiBbIFwicmVhY3RcIiwgXCJlczIwMTVcIiwgXCJlczIwMTZcIiwgXCJlczIwMTdcIiwgXCJzdGFnZS0wXCIgXVxuICAgICAgICAgICAgICAvLyBbXG4gICAgICAgICAgICAgIC8vICAgW1xuICAgICAgICAgICAgICAvLyAgICAgXCJ0YXJnZXRcIiwge1xuICAgICAgICAgICAgICAvLyAgICAgICBwbHVnaW5zOiBbIFwidHJhbnNmb3JtLWRlY29yYXRvcnMtbGVnYWN5XCIgXSxcbiAgICAgICAgICAgICAgLy8gICAgICAgcHJlc2V0czogWyBcImVzMjAxNVwiLCBcImVzMjAxNlwiLCBcImVzMjAxN1wiLCBcInN0YWdlLTBcIiBdLFxuICAgICAgICAgICAgICAvLyAgICAgICB0YXJnZXRzOiBbXG4gICAgICAgICAgICAgIC8vICAgICAgICAgeyBuYW1lOiBcImNocm9tZVwiLCB2ZXJzaW9uOiA1MiB9XG4gICAgICAgICAgICAgIC8vICAgICAgIF1cbiAgICAgICAgICAgICAgLy8gICAgIH1cbiAgICAgICAgICAgICAgLy8gICBdXG4gICAgICAgICAgICAgIC8vIF1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYoaXNEZXZlbG9wbWVudCkge1xuICAgICAgICAgICAgICBiYWJlbFF1ZXJ5LnByZXNldHMgPSBbXG4gICAgICAgICAgICAgICAgXCJyZWFjdC1obXJlXCIsXG4gICAgICAgICAgICAgICAgLi4uYmFiZWxRdWVyeS5wcmVzZXRzXG4gICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIC4uLmJhc2UsXG4gICAgICAgICAgICAgICAgbG9hZGVyOiAnYmFiZWwtbG9hZGVyJyxcbiAgICAgICAgICAgICAgICBxdWVyeTogYmFiZWxRdWVyeVxuICAgICAgICAgICAgICAgIC8vIGxvYWRlcjogY29tYmluZUxvYWRlcnMoW1xuICAgICAgICAgICAgICAgIC8vICAge1xuICAgICAgICAgICAgICAgIC8vICAgICBsb2FkZXI6ICdyZWFjdC1ob3QtbG9hZGVyJ1xuICAgICAgICAgICAgICAgIC8vICAgfSxcbiAgICAgICAgICAgICAgICAvLyAgIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgbG9hZGVyOiAnYmFiZWwtbG9hZGVyJyxcbiAgICAgICAgICAgICAgICAvLyAgICAgcXVlcnk6IGJhYmVsUXVlcnlcbiAgICAgICAgICAgICAgICAvLyAgIH1cbiAgICAgICAgICAgICAgICAvLyBdKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIC4uLmJhc2UsXG4gICAgICAgICAgICAgICAgbG9hZGVyOiAnYmFiZWwtbG9hZGVyJyxcbiAgICAgICAgICAgICAgICBxdWVyeTogYmFiZWxRdWVyeVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkoKSxcblxuICAgICAgICAgIC8vIEpzb25cbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXN0OiAvXFwuanNvbi8sXG4gICAgICAgICAgICBleGNsdWRlOiBleGNsdWRlLFxuICAgICAgICAgICAgbG9hZGVyOiBcImpzb24tbG9hZGVyXCJcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gTk9URTogQWRkIG1vcmUgbG9hZGVycyBoZXJlXG4gICAgICAgIF1cblxuICAgICAgICByZXR1cm4gbG9hZGVyc1xuICAgICAgfSkoKVxuICAgIH0sXG4gICAgcG9zdGNzczogZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIFtwcmVjc3MsIGF1dG9wcmVmaXhlcl07XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbmZpZ1xuIl19